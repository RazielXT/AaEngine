import ssao.SSAO
import exposure.Exposure
import bloom.Bloom
import godray.Godray
import water.Water

compositor Frame
{
	texture sceneTexture target_size Albedo:DXGI_FORMAT_R8G8B8A8_UNORM Normal:DXGI_FORMAT_R16G16B16A16_FLOAT MotionVectors:DXGI_FORMAT_R16G16_FLOAT Depth
	texture sceneVCT target_size DXGI_FORMAT_R8G8B8A8_UNORM
	alias sceneTextureTmp2 sceneVCT

	texture sceneVCTLow target_size_div 2 DXGI_FORMAT_R8G8B8A8_UNORM
	texture sceneTextureTmp target_size DXGI_FORMAT_R8G8B8A8_UNORM

	texture sceneDownscale2 target_size_div 2 DXGI_FORMAT_R8G8B8A8_UNORM
	texture sceneDownscale4 target_size_div 8 DXGI_FORMAT_R8G8B8A8_UNORM

	texture depthDownsample2 target_size_div 2 DXGI_FORMAT_R32_FLOAT

#if UPSCALE
	texture motionVectors target_size DXGI_FORMAT_R16G16_FLOAT
	rwtexture sceneTextureTmp_upscaled output_size DXGI_FORMAT_R8G8B8A8_UNORM
#else
	texture sceneTextureTmpOut output_size DXGI_FORMAT_R8G8B8A8_UNORM
#endif

	texture voxelDummy 128 128 DXGI_FORMAT_R8G8B8A8_UNORM

	task PrepareFrame
	{
	}

	task Shadows
	{
		after PrepareFrame
	}

	task VoxelScene
	{
		after Shadows
		target voxelDummy
	}

	task SceneRender
	{
		entry EarlyZ
		target sceneTexture:Depth
	}

	task SceneRender
	{
		after VoxelScene
		entry Opaque
		target sceneTexture
	}

	ref SSAO(sceneTexture:Depth)

	pass DeferredVCT
	{
		material DeferredVCT
		input sceneTexture:Normal
		input sceneTexture:Depth
		target sceneVCTLow
	}

	pass UpsampleDeferredVCT
	{
		material UpsampleDepthAware
		input sceneVCTLow
		input SSAO.linearDepth
		input SSAO.linearDepthDownsample2
		input sceneTexture:Normal
		target sceneVCT
	}

	pass DeferredLighting
	{
		material DeferredLighting
		input sceneTexture:Albedo
		input sceneTexture:Normal
		input sceneTexture:Depth
		input SSAO.aoSmooth
		input sceneVCT
		target sceneTextureTmp
	}

	pass DepthDownsample
	{
		material LoadThrough
		input sceneTexture:Depth
		target depthDownsample2
	}

	ref Water(sceneTextureTmp,sceneTexture:Depth,depthDownsample2,sceneTextureTmp2)

	pass SceneDownsample
	{
		material PassThrough
		input sceneTextureTmp2
		target sceneDownscale2
	}
	pass SceneDownsample
	{
		material PassThrough
		input sceneDownscale2
		target sceneDownscale4
	}

	task SceneRender
	{
		entry Debug
		target sceneTextureTmp2 sceneTexture:MotionVectors
	}

	ref Exposure(sceneTextureTmp2)

	ref Bloom(sceneDownscale4,Exposure.exposure)

	task SceneRender
	{
		entry Editor
		target sceneTextureTmp2 sceneTexture:Depth (depth_read)
	}

#if UPSCALE
	task UpscalePrepare

	pass MotionVectors
	{
		material MotionVectors
		input sceneTexture:Depth
		input sceneTexture:MotionVectors
		target motionVectors
	}

	task Upscale (compute_shader)
	{
		input sceneTextureTmp2
		input motionVectors
		input sceneTexture:Depth
		input sceneTextureTmp_upscaled
	}

	ref Godray(sceneTextureTmp_upscaled,sceneTexture:Depth)

	pass ToneMapping
	{
		material ToneMappingNoLuma
		input sceneTextureTmp_upscaled
		input Bloom.bloomTexture
		input Exposure.exposure
		input Godray.godray
		target Output
	}
#else
	ref Godray(sceneTextureTmp2,sceneTexture:Depth)

	pass ToneMapping
	{
		material ToneMapping
		input sceneTextureTmp2
		input Bloom.bloomTexture
		input Exposure.exposure
		input Godray.godray
		target sceneTextureTmpOut
	}

	pass Fxaa
 	{
		material FXAA
		input sceneTextureTmpOut
 		target Output
 	}
#endif

	task DebugOverlay
	{
		target Output
	}
}
